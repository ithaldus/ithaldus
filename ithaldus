#!/bin/bash
# =============================================================================
# ithaldus - Unified Development and Production Runner
# =============================================================================
# This script manages both development and production environments.
#
# Development (--dev):
#   Uses OrbStack VM on Mac for proper VPN routing, with source mounted
#   for hot reload. Runs Vite + Bun dev servers.
#
# Production (default):
#   Builds optimized container image for Podman/Docker deployment.
#   Supports OpenVPN, SSTP, and WireGuard for network access.
#
# Usage:
#   ./ithaldus --dev [command]    Development mode (OrbStack VM)
#   ./ithaldus [command]          Production mode
# =============================================================================
set -e

# Configuration
VM_NAME="ithaldus-vm"
CONTAINER_NAME="ithaldus"
VPN_NAME="${VPN_NAME:-client}"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_PATH_IN_VM="/mnt/mac${SCRIPT_DIR}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log() { echo -e "${GREEN}▶${NC} $1"; }
warn() { echo -e "${YELLOW}⚠${NC} $1"; }
error() { echo -e "${RED}✗${NC} $1"; }

# =============================================================================
# Development Mode (OrbStack VM)
# =============================================================================

dev_get_ip() {
    orb list 2>/dev/null | grep "$VM_NAME" | awk '{print $NF}'
}

dev_vm_running() {
    orb list 2>/dev/null | grep "$VM_NAME" | grep -q "running"
}

dev_container_exists() {
    orb run -m "$VM_NAME" docker ps -a --format '{{.Names}}' 2>/dev/null | grep -q "^${CONTAINER_NAME}-dev$"
}

dev_ensure_vm() {
    if ! orb list 2>/dev/null | grep -q "$VM_NAME"; then
        log "Creating OrbStack VM '$VM_NAME'..."
        orb create ubuntu "$VM_NAME"

        log "Installing dependencies in VM..."
        orb run -m "$VM_NAME" sudo apt-get update
        orb run -m "$VM_NAME" sudo apt-get install -y openvpn docker.io
        orb run -m "$VM_NAME" bash -c 'sudo usermod -aG docker $(whoami)'

        warn "VM created. You need to configure VPN:"
        echo "  1. Copy VPN config to VM:"
        echo "     orb push <your-vpn>.ovpn $VM_NAME:/tmp/"
        echo "     orb run -m $VM_NAME sudo mkdir -p /etc/openvpn/client"
        echo "     orb run -m $VM_NAME sudo mv /tmp/<your-vpn>.ovpn /etc/openvpn/client/$VPN_NAME.conf"
        echo "  2. Enable VPN service:"
        echo "     orb run -m $VM_NAME sudo systemctl enable openvpn-client@$VPN_NAME"
        exit 1
    fi

    if ! dev_vm_running; then
        log "Starting VM..."
        orb start "$VM_NAME"
        sleep 3
    fi
}

dev_start() {
    dev_ensure_vm

    # Start VPN
    log "Starting VPN..."
    orb run -m "$VM_NAME" sudo systemctl start openvpn-client@$VPN_NAME 2>/dev/null || true
    sleep 2

    # Check VPN status
    VPN_STATUS=$(orb run -m "$VM_NAME" systemctl is-active openvpn-client@$VPN_NAME 2>/dev/null || echo "inactive")
    if [ "$VPN_STATUS" != "active" ]; then
        warn "VPN not running. Network scanning may not work."
    else
        log "VPN connected"
    fi

    # Run development container
    log "Starting development server..."
    orb run -m "$VM_NAME" docker rm -f "${CONTAINER_NAME}-dev" 2>/dev/null || true

    orb run -m "$VM_NAME" docker run -d \
        --name "${CONTAINER_NAME}-dev" \
        --network host \
        -v "$PROJECT_PATH_IN_VM:/app" \
        -v "$PROJECT_PATH_IN_VM/data:/data" \
        -w /app \
        -e DATABASE_URL=file:/data/ithaldus.db \
        -e AUTH_BYPASS=true \
        oven/bun:1 \
        sh -c "bun install && bun run dev"

    IP=$(dev_get_ip)
    echo ""
    log "Development server starting..."
    echo -e "${CYAN}   URL: http://$IP:5173${NC}"
    echo ""
    echo "Commands:"
    echo "  ./ithaldus --dev logs     View logs"
    echo "  ./ithaldus --dev stop     Stop server"
    echo "  ./ithaldus --dev shell    Open shell in container"
}

dev_stop() {
    log "Stopping development container..."
    orb run -m "$VM_NAME" docker stop "${CONTAINER_NAME}-dev" 2>/dev/null || true
    orb run -m "$VM_NAME" docker rm "${CONTAINER_NAME}-dev" 2>/dev/null || true
    log "Stopped. VM still running."
}

dev_logs() {
    orb run -m "$VM_NAME" docker logs -f "${CONTAINER_NAME}-dev"
}

dev_status() {
    if ! dev_vm_running; then
        echo "VM: stopped"
        return
    fi

    echo "VM: running"
    IP=$(dev_get_ip)
    echo "IP: $IP"

    VPN_STATUS=$(orb run -m "$VM_NAME" systemctl is-active openvpn-client@$VPN_NAME 2>/dev/null || echo "unknown")
    echo "VPN: $VPN_STATUS"

    CONTAINER_STATUS=$(orb run -m "$VM_NAME" docker inspect -f '{{.State.Status}}' "${CONTAINER_NAME}-dev" 2>/dev/null || echo "not running")
    echo "Container: $CONTAINER_STATUS"

    if [ "$CONTAINER_STATUS" = "running" ]; then
        echo ""
        echo -e "${CYAN}URL: http://$IP:5173${NC}"
    fi
}

dev_shell() {
    orb run -m "$VM_NAME" docker exec -it "${CONTAINER_NAME}-dev" sh
}

dev_vm_shell() {
    orb run -m "$VM_NAME" bash
}

dev_vm_stop() {
    log "Stopping VM..."
    orb stop "$VM_NAME"
    log "VM stopped."
}

dev_open() {
    IP=$(dev_get_ip)
    open "http://$IP:5173"
}

dev_exec() {
    shift  # Remove 'exec'
    orb run -m "$VM_NAME" docker exec -it "${CONTAINER_NAME}-dev" "$@"
}

# =============================================================================
# Production Mode
# =============================================================================

prod_build() {
    log "Building production image..."

    # Use podman if available, otherwise docker
    if command -v podman &> /dev/null; then
        RUNTIME="podman"
    else
        RUNTIME="docker"
    fi

    $RUNTIME build -t ithaldus -f Dockerfile.prod "$SCRIPT_DIR"
    log "Image built: ithaldus"
}

prod_run() {
    log "Starting production container..."

    if command -v podman &> /dev/null; then
        RUNTIME="podman"
    else
        RUNTIME="docker"
    fi

    # Stop existing container
    $RUNTIME stop ithaldus 2>/dev/null || true
    $RUNTIME rm ithaldus 2>/dev/null || true

    # Load env file if exists
    ENV_FILE=""
    if [ -f "$SCRIPT_DIR/.env" ]; then
        ENV_FILE="--env-file $SCRIPT_DIR/.env"
    fi

    $RUNTIME run -d \
        --name ithaldus \
        --cap-add=NET_ADMIN \
        --device=/dev/net/tun \
        -p 3000:3000 \
        -v "$SCRIPT_DIR/data:/data" \
        $ENV_FILE \
        ithaldus

    log "Production server running at http://localhost:3000"
}

prod_logs() {
    if command -v podman &> /dev/null; then
        podman logs -f ithaldus
    else
        docker logs -f ithaldus
    fi
}

prod_stop() {
    log "Stopping production container..."
    if command -v podman &> /dev/null; then
        podman stop ithaldus
    else
        docker stop ithaldus
    fi
}

prod_status() {
    echo -e "${CYAN}IT Haldus - Status${NC}"
    echo ""

    # Check dev container (docker-compose)
    DEV_STATUS=$(docker compose ps --format json 2>/dev/null | grep -o '"State":"[^"]*"' | head -1 | cut -d'"' -f4)
    if [ -n "$DEV_STATUS" ] && [ "$DEV_STATUS" = "running" ]; then
        echo -e "Dev:  ${GREEN}running${NC} → http://localhost:3000"
    else
        echo -e "Dev:  ${RED}stopped${NC}"
    fi

    # Check prod container
    if command -v podman &> /dev/null; then
        RUNTIME="podman"
    else
        RUNTIME="docker"
    fi

    PROD_STATUS=$($RUNTIME ps --filter "name=^ithaldus$" --format '{{.Status}}' 2>/dev/null || true)
    if [ -n "$PROD_STATUS" ]; then
        echo -e "Prod: ${GREEN}running${NC} ($PROD_STATUS)"
    else
        echo -e "Prod: ${RED}stopped${NC}"
    fi

    # Check OrbStack dev VM (if on Mac)
    if command -v orb &> /dev/null; then
        VM_STATUS=$(orb list 2>/dev/null | grep "$VM_NAME" | awk '{print $2}')
        if [ "$VM_STATUS" = "running" ]; then
            VM_IP=$(orb list 2>/dev/null | grep "$VM_NAME" | awk '{print $NF}')
            echo -e "VM:   ${GREEN}running${NC} ($VM_IP)"
        else
            echo -e "VM:   ${RED}stopped${NC}"
        fi
    fi
}

# =============================================================================
# VPN Commands
# =============================================================================

get_runtime() {
    # Check which runtime has the container running
    if docker ps --filter "name=^ithaldus$" --format '{{.Names}}' 2>/dev/null | grep -q ithaldus; then
        echo "docker"
    elif podman ps --filter "name=^ithaldus$" --format '{{.Names}}' 2>/dev/null | grep -q ithaldus; then
        echo "podman"
    elif command -v podman &> /dev/null; then
        echo "podman"
    else
        echo "docker"
    fi
}

vpn_status() {
    RUNTIME=$(get_runtime)

    echo -e "${CYAN}VPN Status${NC}"
    echo ""

    VPN_PROTOCOL=$($RUNTIME exec ithaldus printenv VPN_PROTOCOL 2>/dev/null || echo "unknown")
    echo "Protocol: $VPN_PROTOCOL"
    echo ""

    echo "Network interfaces:"
    $RUNTIME exec ithaldus ip addr show 2>/dev/null | grep -E "^[0-9]+:|inet " || echo "  (container not running)"
    echo ""

    echo "Routes:"
    $RUNTIME exec ithaldus ip route 2>/dev/null || echo "  (container not running)"
}

vpn_logs() {
    RUNTIME=$(get_runtime)
    $RUNTIME exec ithaldus cat /var/log/supervisor/vpn.out.log 2>/dev/null || \
        $RUNTIME exec ithaldus cat /var/log/supervisor/vpn.err.log 2>/dev/null || \
        echo "No VPN logs available"
}

vpn_test() {
    if [ -z "$1" ]; then
        echo "Usage: ./ithaldus vpn-test <ip-address>"
        echo ""
        echo "Test connectivity to a target IP through the VPN."
        exit 1
    fi

    RUNTIME=$(get_runtime)
    log "Testing connectivity to $1..."
    $RUNTIME exec ithaldus ping -c 3 "$1"
}

# =============================================================================
# Main
# =============================================================================

show_help() {
    echo "IT Haldus - Organization IT Management Tool"
    echo ""
    echo "Usage: ./ithaldus [--dev] <command>"
    echo ""
    echo "Development Mode (--dev):"
    echo "  Uses OrbStack VM on Mac with VPN for network access."
    echo "  Source code is mounted for hot reload."
    echo ""
    echo "  ./ithaldus --dev start      Start dev server (VM + VPN + container)"
    echo "  ./ithaldus --dev stop       Stop dev container"
    echo "  ./ithaldus --dev logs       Follow dev logs"
    echo "  ./ithaldus --dev status     Show status"
    echo "  ./ithaldus --dev shell      Shell into dev container"
    echo "  ./ithaldus --dev vm-shell   Shell into VM"
    echo "  ./ithaldus --dev vm-stop    Stop the VM entirely"
    echo "  ./ithaldus --dev open       Open in browser"
    echo "  ./ithaldus --dev exec <cmd> Run command in container"
    echo ""
    echo "Production Mode (default):"
    echo "  Builds and runs optimized container with VPN."
    echo ""
    echo "  ./ithaldus build            Build production image"
    echo "  ./ithaldus run              Run production container"
    echo "  ./ithaldus start            Build and run"
    echo "  ./ithaldus stop             Stop production container"
    echo "  ./ithaldus logs             Follow production logs"
    echo "  ./ithaldus status           Show container status"
    echo ""
    echo "VPN Commands:"
    echo "  ./ithaldus vpn-status       Show VPN connection status"
    echo "  ./ithaldus vpn-logs         Show VPN logs"
    echo "  ./ithaldus vpn-test <ip>    Test connectivity through VPN"
    echo ""
}

# Check for --dev flag
if [ "${1:-}" = "--dev" ]; then
    shift
    CMD="${1:-start}"

    case "$CMD" in
        start)   dev_start ;;
        stop)    dev_stop ;;
        logs)    dev_logs ;;
        status)  dev_status ;;
        shell)   dev_shell ;;
        vm-shell) dev_vm_shell ;;
        vm-stop) dev_vm_stop ;;
        open)    dev_open ;;
        exec)    dev_exec "$@" ;;
        help|--help|-h) show_help ;;
        *)       error "Unknown command: $CMD"; show_help; exit 1 ;;
    esac
else
    CMD="${1:-help}"

    case "$CMD" in
        build)   prod_build ;;
        run)     prod_run ;;
        start)   prod_build && prod_run ;;
        stop)    prod_stop ;;
        logs)    prod_logs ;;
        status)  prod_status ;;
        vpn-status)  vpn_status ;;
        vpn-logs)    vpn_logs ;;
        vpn-test)    vpn_test "$2" ;;
        help|--help|-h) show_help ;;
        *)       error "Unknown command: $CMD"; show_help; exit 1 ;;
    esac
fi
