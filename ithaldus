#!/bin/bash
# =============================================================================
# ithaldus - Unified Development and Production Runner
# =============================================================================
# This script manages both development and production environments.
#
# Development (--dev):
#   Uses OrbStack VM on Mac for proper VPN routing, with source mounted
#   for hot reload. Runs Vite + Bun dev servers.
#
# Production (default):
#   Builds optimized container image for Podman/Docker deployment.
#   Supports OpenVPN, SSTP, and WireGuard for network access.
#
# Usage:
#   ./ithaldus --dev [command]    Development mode (OrbStack VM)
#   ./ithaldus [command]          Production mode
# =============================================================================
set -e

# Configuration
VM_NAME="ithaldus-vm"
CONTAINER_NAME="ithaldus"
VPN_NAME="${VPN_NAME:-client}"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_PATH_IN_VM="/mnt/mac${SCRIPT_DIR}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log() { echo -e "${GREEN}▶${NC} $1"; }
warn() { echo -e "${YELLOW}⚠${NC} $1"; }
error() { echo -e "${RED}✗${NC} $1"; }

# =============================================================================
# Development Mode (OrbStack VM)
# =============================================================================

dev_get_ip() {
    orb list 2>/dev/null | grep "$VM_NAME" | awk '{print $NF}'
}

dev_vm_running() {
    orb list 2>/dev/null | grep "$VM_NAME" | grep -q "running"
}

dev_container_exists() {
    orb run -m "$VM_NAME" docker ps -a --format '{{.Names}}' 2>/dev/null | grep -q "^${CONTAINER_NAME}-dev$"
}

dev_ensure_vm() {
    if ! orb list 2>/dev/null | grep -q "$VM_NAME"; then
        log "Creating OrbStack VM '$VM_NAME'..."
        orb create ubuntu "$VM_NAME"

        log "Installing dependencies in VM..."
        orb run -m "$VM_NAME" sudo apt-get update
        orb run -m "$VM_NAME" sudo apt-get install -y openvpn docker.io
        orb run -m "$VM_NAME" bash -c 'sudo usermod -aG docker $(whoami)'

        warn "VM created. You need to configure VPN:"
        echo "  1. Copy VPN config to VM:"
        echo "     orb push <your-vpn>.ovpn $VM_NAME:/tmp/"
        echo "     orb run -m $VM_NAME sudo mkdir -p /etc/openvpn/client"
        echo "     orb run -m $VM_NAME sudo mv /tmp/<your-vpn>.ovpn /etc/openvpn/client/$VPN_NAME.conf"
        echo "  2. Enable VPN service:"
        echo "     orb run -m $VM_NAME sudo systemctl enable openvpn-client@$VPN_NAME"
        exit 1
    fi

    if ! dev_vm_running; then
        log "Starting VM..."
        orb start "$VM_NAME"
        sleep 3
    fi
}

dev_start() {
    log "Starting development server..."
    docker compose up -d dev

    # Wait for container to start
    sleep 3

    echo ""
    log "Development server started"
    echo -e "${CYAN}   URL: http://localhost:${PORT_WEB:-3000}${NC}"
    echo ""
    echo "Commands:"
    echo "  ./ithaldus --dev logs     View logs"
    echo "  ./ithaldus --dev stop     Stop server"
    echo "  ./ithaldus --dev shell    Open shell in container"
}

dev_stop() {
    log "Stopping development container..."
    docker compose down
    log "Stopped."
}

dev_logs() {
    docker compose logs -f dev
}

dev_status() {
    CONTAINER_STATUS=$(docker compose ps --format '{{.Status}}' dev 2>/dev/null || echo "not running")
    echo "Container: $CONTAINER_STATUS"

    if echo "$CONTAINER_STATUS" | grep -qi "up"; then
        echo ""
        echo -e "${CYAN}URL: http://localhost:${PORT_WEB:-3000}${NC}"
    fi
}

dev_shell() {
    docker compose exec dev sh
}

dev_vm_shell() {
    orb run -m "$VM_NAME" bash
}

dev_vm_stop() {
    log "Stopping VM..."
    orb stop "$VM_NAME"
    log "VM stopped."
}

dev_open() {
    IP=$(dev_get_ip)
    open "http://$IP:5173"
}

dev_exec() {
    shift  # Remove 'exec'
    orb run -m "$VM_NAME" docker exec -it "${CONTAINER_NAME}-dev" "$@"
}

# =============================================================================
# Production Mode
# =============================================================================

prod_build() {
    log "Building production image..."

    # Use podman if available, otherwise docker
    if command -v podman &> /dev/null; then
        RUNTIME="podman"
    else
        RUNTIME="docker"
    fi

    $RUNTIME build -t ithaldus "$SCRIPT_DIR"
    log "Image built: ithaldus"
}

prod_run() {
    log "Starting production container..."

    if command -v podman &> /dev/null; then
        RUNTIME="podman"
    else
        RUNTIME="docker"
    fi

    # Stop existing container
    $RUNTIME stop ithaldus 2>/dev/null || true
    $RUNTIME rm ithaldus 2>/dev/null || true

    # Load env file if exists
    ENV_FILE=""
    if [ -f "$SCRIPT_DIR/.env" ]; then
        ENV_FILE="--env-file $SCRIPT_DIR/.env"
    fi

    $RUNTIME run -d \
        --name ithaldus \
        --cap-add=NET_ADMIN \
        --device=/dev/net/tun \
        -p 3000:3000 \
        -v "$SCRIPT_DIR/data:/data" \
        $ENV_FILE \
        ithaldus

    log "Production server running at http://localhost:3000"
}

prod_logs() {
    if command -v podman &> /dev/null; then
        podman logs -f ithaldus
    else
        docker logs -f ithaldus
    fi
}

prod_stop() {
    log "Stopping production container..."
    if command -v podman &> /dev/null; then
        podman stop ithaldus
    else
        docker stop ithaldus
    fi
}

prod_status() {
    # Load port from .env if exists
    PORT="${PORT_WEB:-3000}"
    if [ -f "$SCRIPT_DIR/.env" ]; then
        PORT=$(grep -E "^PORT_WEB=" "$SCRIPT_DIR/.env" 2>/dev/null | cut -d'=' -f2 || echo "3000")
        [ -z "$PORT" ] && PORT="3000"
    fi

    # Check dev container (docker-compose)
    DEV_RUNNING=false
    DEV_STATUS=$(docker compose ps --format json 2>/dev/null | grep -o '"State":"[^"]*"' | head -1 | cut -d'"' -f4)
    if [ -n "$DEV_STATUS" ] && [ "$DEV_STATUS" = "running" ]; then
        DEV_RUNNING=true
    fi

    # Check prod container
    PROD_RUNNING=false
    if command -v podman &> /dev/null; then
        RUNTIME="podman"
    else
        RUNTIME="docker"
    fi
    PROD_STATUS=$($RUNTIME ps --filter "name=^ithaldus$" --format '{{.Status}}' 2>/dev/null || true)
    if [ -n "$PROD_STATUS" ]; then
        PROD_RUNNING=true
    fi

    # Header
    echo -e "${CYAN}IT Haldus${NC} - Network topology scanner"
    echo ""

    # Status section
    if [ "$DEV_RUNNING" = true ] || [ "$PROD_RUNNING" = true ]; then
        echo -e "  ${GREEN}●${NC} Running"
        echo ""
        if [ "$DEV_RUNNING" = true ]; then
            echo -e "  Dev:  http://localhost:$PORT"
        fi
        if [ "$PROD_RUNNING" = true ]; then
            echo -e "  Prod: http://localhost:$PORT"
        fi
    else
        echo -e "  ${RED}●${NC} Stopped"
    fi
    echo ""
}

# =============================================================================
# VPN Commands
# =============================================================================

get_runtime() {
    # Check which runtime has the container running
    if docker ps --filter "name=^ithaldus$" --format '{{.Names}}' 2>/dev/null | grep -q ithaldus; then
        echo "docker"
    elif podman ps --filter "name=^ithaldus$" --format '{{.Names}}' 2>/dev/null | grep -q ithaldus; then
        echo "podman"
    elif command -v podman &> /dev/null; then
        echo "podman"
    else
        echo "docker"
    fi
}

vpn_status() {
    RUNTIME=$(get_runtime)

    echo -e "${CYAN}VPN Status${NC}"
    echo ""

    VPN_PROTOCOL=$($RUNTIME exec ithaldus printenv VPN_PROTOCOL 2>/dev/null || echo "unknown")
    echo "Protocol: $VPN_PROTOCOL"
    echo ""

    echo "Network interfaces:"
    $RUNTIME exec ithaldus ip addr show 2>/dev/null | grep -E "^[0-9]+:|inet " || echo "  (container not running)"
    echo ""

    echo "Routes:"
    $RUNTIME exec ithaldus ip route 2>/dev/null || echo "  (container not running)"
}

vpn_logs() {
    RUNTIME=$(get_runtime)
    $RUNTIME exec ithaldus cat /var/log/supervisor/vpn.out.log 2>/dev/null || \
        $RUNTIME exec ithaldus cat /var/log/supervisor/vpn.err.log 2>/dev/null || \
        echo "No VPN logs available"
}

vpn_test() {
    if [ -z "$1" ]; then
        echo "Usage: ./ithaldus vpn-test <ip-address>"
        echo ""
        echo "Test connectivity to a target IP through the VPN."
        exit 1
    fi

    RUNTIME=$(get_runtime)
    log "Testing connectivity to $1..."
    $RUNTIME exec ithaldus ping -c 3 "$1"
}

# =============================================================================
# Main
# =============================================================================

show_help() {
    echo "Usage: ./ithaldus [command]"
    echo ""
    echo "Commands:"
    echo "  start             Build and start production container"
    echo "  stop              Stop production container"
    echo "  logs              Follow production logs"
    echo "  build             Build production image only"
    echo ""
    echo "  --dev start       Start dev server (docker-compose)"
    echo "  --dev stop        Stop dev container"
    echo "  --dev logs        Follow dev logs"
    echo ""
    echo "  vpn-status        Show VPN connection status"
    echo "  vpn-logs          Show VPN logs"
    echo "  vpn-test <ip>     Test connectivity through VPN"
    echo ""
}

# Check for --dev flag
if [ "${1:-}" = "--dev" ]; then
    shift
    CMD="${1:-start}"

    case "$CMD" in
        start)   dev_start ;;
        stop)    dev_stop ;;
        logs)    dev_logs ;;
        status)  dev_status ;;
        shell)   dev_shell ;;
        vm-shell) dev_vm_shell ;;
        vm-stop) dev_vm_stop ;;
        open)    dev_open ;;
        exec)    dev_exec "$@" ;;
        help|--help|-h) show_help ;;
        *)       error "Unknown command: $CMD"; show_help; exit 1 ;;
    esac
else
    CMD="${1:-}"

    case "$CMD" in
        build)   prod_build ;;
        run)     prod_run ;;
        start)   prod_build && prod_run ;;
        stop)    prod_stop ;;
        logs)    prod_logs ;;
        status)  prod_status ;;
        vpn-status)  vpn_status ;;
        vpn-logs)    vpn_logs ;;
        vpn-test)    vpn_test "$2" ;;
        help|--help|-h) prod_status; show_help ;;
        "")      prod_status; show_help ;;
        *)       error "Unknown command: $CMD"; show_help; exit 1 ;;
    esac
fi
